import { VulnerabilitiesData } from "@/components/sections/browse-images/mockdata";
import { ColumnDef } from "@tanstack/react-table";
import dayjs from "dayjs";
import relativeTime from "dayjs/plugin/relativeTime";
import { ChevronDown } from "lucide-react";
import { ArrowsSort } from "tabler-icons-react";

dayjs.extend(relativeTime);

export interface ImageVulnerability {
    id: string;
    severity: "low" | "normal" | "high" | "critical";
    package: string;
    version: string;
    lastDetected: string
}

export function useImageVulnerabilitiesColumn(): ColumnDef<VulnerabilitiesData>[] {
    return [
        {
            accessorKey: "id",
            header: () => (
                <div className="flex items-center gap-2">
                    <span className="text-xs font-medium">CVE ID</span>
                    <ArrowsSort size={15} className="text-muted-foreground" />
                </div>
            ),
            cell: ({ row }) => (
                <div className="flex items-center gap-2">
                    <button
                        aria-label={row.getIsExpanded() ? 'Collapse row' : 'Expand row'}
                        onClick={() => row.toggleExpanded()}
                        className="flex items-center justify-center w-6 h-6 rounded hover:bg-muted/30"
                        style={{ outline: 'none', border: 'none', background: 'none', cursor: 'pointer' }}
                    >
                        <ChevronDown
                            size={16}
                            className={`transition-transform text-muted-foreground ${row.getIsExpanded() ? 'rotate-180' : ''}`}
                        />
                    </button>
                    <span>{row.getValue("id")}</span>
                </div>
            )
        },
        {
            accessorKey: "severity",
            header: () => (
                <div className="flex items-center gap-2">
                    <span className="text-xs font-medium uppercase">Severity</span>
                    <ArrowsSort size={15} className="text-muted-foreground" />
                </div>
            ),
            cell: ({ row }) => {
                const severity = (row.getValue("severity") as string)?.toLowerCase();
                const label = severity.charAt(0).toUpperCase() + severity.slice(1);
                return (
                    <div className={`priority-tag priority-${severity}`}>
                        <div className="priority-dot"></div>
                        <span>{label}</span>
                    </div>
                )
            }
        },
        {
            accessorKey: "package",
            header: () => (
                <div className="flex items-center gap-2">
                    <span className="text-xs font-medium uppercase">Package</span>
                    <ArrowsSort size={15} className="text-muted-foreground" />
                </div>
            ),
            cell: ({ row }) => (
                <span>{row.getValue("package")}</span>
            )
        },
        {
            accessorKey: "version",
            header: () => (
                <div className="flex items-center gap-2">
                    <span className="text-xs font-medium uppercase">Version</span>
                    <ArrowsSort size={15} className="text-muted-foreground" />
                </div>
            ),
            cell: ({ row }) => (
                <span>{row.getValue("version")}</span>
            )
        },
        {
            accessorKey: "lastDetected",
            header: () => (
                <div className="flex items-center gap-2">
                    <span className="text-xs font-medium uppercase">Last Detected</span>
                    <ArrowsSort size={15} className="text-muted-foreground" />
                </div>
            ),
            cell: ({ row }) => {
                const lastDetected = dayjs(row.getValue("lastDetected"));
                return (
                    <div className="flex flex-col">
                        <span className="text-sm">{lastDetected.fromNow()}</span>
                        <span className="text-xs text-muted-foreground">{lastDetected.format(("DD MMM YYYY â€¢ HH:mm:ss"))}</span>
                    </div>
                );
            }
        }
    ]
}
